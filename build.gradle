/*
 * Copyright 2012 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

allprojects {
	configurations {
		compile
		platform {
			extendsFrom compile
		}
		examples {
			extendsFrom compile			
		}
	}
}

subprojects {
	apply plugin: 'java'
	apply plugin: 'eclipse'
	apply plugin: 'idea'

	sourceCompatibility = '1.7'
	targetCompatibility = '1.7'

	repositories {
		mavenCentral()
	}

	dependencies {
		testCompile "junit:junit:$junitVersion"
	}

	test {
		useTestNG()
		include "**/*Test.class"
		systemProperty "java.util.logging.config.file", "conf/logging.properties"
	}
}

ext.releaseDir = file("$rootProject.buildDir/releases/$rootProject.name-$version")

// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
// vert.x core tasks

def distSpec = copySpec {
	def busmods = subprojects.findAll { p-> p.name.matches('vertx-mods-.*') }
	def release = "$rootProject.name-$version"

	into("$release") {
		from 'src', 'LICENSE.txt', "README.md"
	}

	into("$release/bin") {
		from project(":vertx-boot").jar
	}

	into("$release/examples") {
		from file('vertx-examples/src/main')
	}

//	into("$release/docs/groovy/api") {
//		from subprojects.groovydoc
//	}

	into("$release/docs/java/api") {
		from subprojects.javadoc
	}

//	into("$release/docs/javascript/api") {
//		from subprojects.rhinodoc
//	}

//	into("$release/docs/ruby/api") {
//		from subprojects.yardoc
//	}

	subprojects.findAll { p-> p.name.matches('vertx-core.*') }.each { proj->
		into("$release/lib") {
			from proj.jar, proj.configurations.compile
		}
	}

	subprojects.findAll { p-> p.name.matches('vertx-lang-.*') }.each { proj->
		into("$release/lib") {
			from proj.jar, proj.configurations.compile
		}
	}

	subprojects.findAll { p-> p.name.matches('vertx-mods-.*') }.each { mod->
		def name = mod.name.replaceFirst('vertx-mods-', '')
		into("$release/mods/$name") {
			from "$mod.projectDir/src/main/conf"
			into('lib') {
				from mod.jar, mod.configurations.compile
				exclude 'vertx-core*'
			}
		}
	}
}

task clean(dependsOn: 'cleanRelease') {
	group = 'vert.x'
	description = 'Perform a full clean of the main project and subprojects'
}

task cleanRelease() {
	group = 'vert.x'
	description = 'Clean only the release directory'
	
	def releases = file("build/releases")
	if (releases.exists()) { 
		boolean deleted = releases.delete() 
		if (!deleted) {
			// TODO check why this doesn't clear the dir sometimes
			println "WARNING: directory '$releases' was not deleted"
		}
	}
}

task prepareRelease(type: Sync) {
	group = 'vert.x'
	description = 'Prepare the release directory'

	into "$buildDir/releases"
	with distSpec

	doLast {
		def releaseDir = mkdir("$buildDir/releases/$rootProject.name-$version")
		['logs', 'temp'].each { dir->
			new File(releaseDir, dir).mkdirs()
		}
	}
}

task dist(type: Tar, dependsOn: ['prepareRelease']) {
	group = 'vert.x'
	description = 'Build the tarball distribution.'

	destinationDir = file('build/distributions')
	baseName = rootProject.name
	version = rootProject.version
	from 'build/releases'
	include "$rootProject.name-$version/**"

	compression = org.gradle.api.tasks.bundling.Compression.GZIP
	
	doLast {
		println "Distribution packaged: $destinationDir/$archiveName"
	}
}

task installApp(type: Sync, dependsOn: ['prepareRelease']) {
	group = 'vert.x'
	description = 'install a local version of this build'
	from 'build/releases'
	include "$rootProject.name-$version/**"

	if (System.getenv()['VERTX_HOME']) {
	  into System.getenv()['VERTX_HOME']
	}
	else {
	  into System.getProperty('java.io.tmpdir') + "/$rootProject.name-$version"
	}
}

task wrapper(type: Wrapper) {
	group = 'setup'
	description = 'Configures a Gradle wrapper'
	gradleVersion = "$gradleVersion"
}
